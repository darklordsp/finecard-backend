# 6tamp-backend

#### Authorization for coffee shops (methods without JWT token validation)
- **/auth/signup** - registration, mail arrives in the body (optional - password, if not specified - generated by itself, the name of the coffee shop, phone number, max. number of stamps). Returns the user ID and JWT token, or a corresponding error.

- **/auth/signin** - login, the body receives mail, password, returns either a JWT token for subsequent authorization or a corresponding error.

- **/auth/restore** - password recovery. Mail arrives, generates a new password, updates its hash in the user, sends a new password to the specified mail and returns true if successful, or a corresponding error (for example, no such mail was found)

### Working with cards (hereinafter, all requests must be signed with a JWT token, from which we get the user context in which we work)

- **/cards/generate** - issue a new card. The body receives a phone number. We check if there is such a client in the database. If there is, send him an SMS link to add an already created card. If not, we generate it, save it in the field, send it via SMS. To generate a card, three parameters are required - restaurant ID, phone number, customer ID. You need to come up with some kind of encoder-decoder (look at npm), and encrypt the json string with these 3 parameters into a regular string, which is sewn into the QR code on the card. Returns ID

- **/cards/check** - "scan" the card. The body receives a string generated by method 2.a. It is necessary to decrypt it, check the existence of such a bundle, and perform the fact of scanning according to the following scheme: If the client has the current number of stamps +1 = the maximum number of stamps at the coffee shop, then it is necessary to return an answer indicating this, and also reset the number of stamps for the client. If the number of stamps + 1 <the maximum number of stamps at the coffee shop, then we simply add 1 to the number of the customer's stamps and return a response indicating the current number of stamps (eg ⅚). In all cases, we create a new entry in the scan table.

### Working with clients.

- **/client/invite** - invite a new client to the loyalty program. The body receives a phone number. We check if the coffee shop already has such a client, and if so, we return the appropriate response. If not, we generate a card like method 2.a, save the user to the database, send an SMS with a link to add a card. Returns the ID of the created user. In this case, the field “Confirmed” for the user created by this method is equal to true

- **/:cafeid/client/register** - this method does not require JWT token authorization. The body receives an ID phone number. It is necessary to create a user in the database, and the “Confirmed” field will be false. It is necessary to generate a 4-digit digital code and send it via SMS to the specified number. And also create a corresponding record in the database

- **/:cafeid/client/confirm** - this method does not require JWT token authorization. The body receives a code, a phone number. We find by the ID of the coffee shop, code and phone number an entry in the code table. If there is such a record, set the user with this number to “Confirmed” to true. Generate a card for the user as in method 2.a, save the link to it and send it via SMS.

- **/:cafeid/client/regencode** - this method does not require JWT token authorization. The body receives a phone number. Using the cafeid link and the phone number, we find the user, issue a new confirmation code for him, save the code to the database and send the new code via SMS. 

#### Installation
```Bash
    npm install
```    
#### Start
```Javascript
    npm start
```
